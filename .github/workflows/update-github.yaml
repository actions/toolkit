name: update-github

on:
  workflow_dispatch:

jobs:
  update-octokit:
    name: Update Octokit
    runs-on: ubuntu-latest

    if: ${{ github.repository_owner == 'actions' }}

    defaults:
      run:
        working-directory: packages/github

    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v4

      - name: Update Octokit
        id: update-octokit
        run: |
          npx npm-check-updates -u --dep prod
          npm install

      - name: Check Status
        id: status
        run: |
          if [[ "$(git status --porcelain)" != "" ]]; then 
            echo "::set-output name=create_pr::true"
            git config --global user.email "github-actions@github.com"
            git config --global user.name "github-actions[bot]"
            git checkout -b bots/updateGitHubDependencies-${{github.run_number}}
            git add .
            git commit -m "Update Dependencies"
            git push --set-upstream origin bots/updateGitHubDependencies-${{github.run_number}}
          fi

      - if: ${{steps.status.outputs.create_pr}}
        name: Create Pull Request
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            await github.pulls.create(
              {
                base: "main",
                owner: "${{github.repository_owner}}",
                repo: "toolkit",
                title: "Update Octokit Dependencies",
                body: "Update Octokit Dependencies",
                head: "bots/updateGitHubDependencies-${{github.run_number}}"
              }
            )
